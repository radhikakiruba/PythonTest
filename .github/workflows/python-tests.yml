name: CI/CD Pipeline - Structured Extraction Tool

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Orchestrate Services
      - name: Start Infrastructure (DB & LocalStack)
        run: docker-compose up -d db localstack

      # 2. Setup Python Environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest-playwright allure-pytest
          playwright install --with-deps

      # 3. Initialize Mock AWS Infrastructure
      # We use the 'localstack' CLI/awslocal to ensure S3/SQS exist before the app starts
      - name: Initialize AWS Resources
        run: |
          pip install awscli-local
          awslocal s3 mb s3://uploads-bucket
          awslocal sqs create-queue --queue-name extraction-queue

      # 4. Start Flask App & Worker in Background
      - name: Start App and Worker
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/consultation_db
          AWS_ENDPOINT_URL: http://localhost:4566
          TEST_MODE: "true" # Enables deterministic Mock LLM responses
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}"
          nohup python src/page.py > flask.log 2>&1 &
          nohup python src/worker.py > worker.log 2>&1 &

      # 5. Wait for Health Check
      - name: Wait for App Readiness
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8000/health >/dev/null; then
              echo "App is ready!"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed. Logs:"
          tail -n 50 flask.log
          exit 1

      # 6. Execute Deterministic Tests
      - name: Run E2E & Integration Tests
        env:
          BASE_URL: http://localhost:8000
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/consultation_db
          AWS_ENDPOINT_URL: http://localhost:4566
        run: pytest tests/ --alluredir=allure-results

      # 7. Reporting Logic
      - name: Generate Allure Report
        if: always()
        run: |
          npx --yes allure generate allure-results -o allure-report

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-report
          path: allure-report

      # 8. Cleanup
      - name: Stop Services
        if: always()
        run: docker-compose down